<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>马大灯笼节 - 幸运抽奖</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Cinzel:wght@900&display=swap');

        :root {
            --primary-gold: #ffdd44;
            --primary-red: #ff3333;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #000;
            background: radial-gradient(circle at center, #4a0e0e 0%, #1a0505 50%, #000000 100%);
            font-family: 'Cinzel', serif;
            color: white;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
        }

        /* --- LAYER 1: GOD RAYS (Back) --- */
        .god-rays {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150vmax;
            height: 150vmax;
            background: repeating-conic-gradient(rgba(255, 235, 150, 0.15) 0deg,
                    rgba(255, 235, 150, 0.15) 15deg,
                    transparent 15deg, transparent 30deg);
            box-shadow: 0 0 100px 80px rgba(255, 200, 50, 0.2);
            mix-blend-mode: screen;
            animation: rotateRays 60s linear infinite;
            z-index: 1;
            pointer-events: none;
        }

        @keyframes rotateRays {
            from {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* --- LAYER 2: LANTERNS (DYNAMIC) --- */
        #lantern-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            /* Default: Low */
            transition: z-index 0.1s step-end;
        }

        /* When revealing, move lanterns BETWEEN Glass(20) and Text(30) */
        body.winner-revealed #lantern-canvas {
            z-index: 25;
        }

        /* --- LAYER 3: GREY GLASS BACKDROP (Independent Layer) --- */
        #glass-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 5, 0.75);
            backdrop-filter: blur(10px);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        #glass-backdrop.visible {
            opacity: 1;
        }

        /* --- LAYER 4: TEXT CONTENT (Top Layer) --- */
        /* This container holds the text and button, placed HIGHER than everything else */
        .content-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            /* Crucial: Higher than lanterns (25) */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .content-layer.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- LAYER 5: FIREWORKS (Explosions on top) --- */
        #firework-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40;
            pointer-events: none;
        }

        /* --- STYLING --- */
        #main-title {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
            padding: 5vh 8vw;
            width: max-content;
            background: linear-gradient(145deg, rgba(40, 40, 40, 0.85), rgba(10, 10, 10, 0.95));
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
        }

        .title-chinese {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 5vw;
            color: var(--primary-gold);
            margin: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8), 0 0 40px rgba(255, 160, 0, 0.8);
            letter-spacing: 12px;
            white-space: nowrap;
        }

        .title-english {
            font-family: 'Cinzel', serif;
            font-size: 1.2vw;
            color: #ffbfbf;
            letter-spacing: 8px;
            margin-top: 15px;
            text-shadow: 0 0 15px rgba(255, 50, 50, 0.8);
            opacity: 0.95;
            white-space: nowrap;
        }

        .title-sub {
            margin-top: 15px;
            font-size: 0.8vw;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        /* Scramble Text */
        #scramble-text {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 15vw;
            color: #fff;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 80px rgba(255, 200, 0, 1.0);
            will-change: transform;
        }

        .scrambling #scramble-text {
            animation: pulse-zoom 0.1s infinite alternate;
            color: #fffbe6;
        }

        @keyframes pulse-zoom {
            0% {
                transform: scale(0.95);
            }

            100% {
                transform: scale(1.05);
            }
        }

        /* Winner Text */
        .winner-label {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 5vw;
            color: var(--primary-gold);
            text-shadow: 0 0 30px #ff3333;
            letter-spacing: 0.5rem;
            margin-bottom: 2vh;
            animation: floatText 3s ease-in-out infinite;
        }

        .winner-number {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 18vw;
            color: #fff;
            text-shadow: 0 0 30px var(--primary-gold), 0 0 100px #ff0000;
            line-height: 1;
        }

        .number-pop {
            animation: superSlam 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes superSlam {
            0% {
                transform: scale(3);
                opacity: 0;
                filter: blur(20px);
            }

            100% {
                transform: scale(1);
                opacity: 1;
                filter: blur(0px);
            }
        }

        @keyframes floatText {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        #controls {
            position: absolute;
            bottom: 12%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            transition: opacity 0.5s ease;
        }

        button {
            background: linear-gradient(to bottom, #c0151a, #660000);
            border: 1px solid rgba(255, 215, 0, 0.4);
            padding: 15px 70px;
            font-size: 28px;
            font-family: 'Ma Shan Zheng', cursive;
            color: var(--primary-gold);
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
            white-space: nowrap;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 80px rgba(255, 200, 0, 0.6);
        }

        button:active {
            transform: scale(0.95);
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
            background: radial-gradient(circle, transparent 40%, rgba(0, 0, 0, 0.9) 100%);
        }

        #flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.05s;
            mix-blend-mode: overlay;
        }
    </style>
</head>

<body>

    <audio id="sfx-storm" src="storm.mp3" preload="auto"></audio>
    <audio id="sfx-boom" src="boom.mp3" preload="auto"></audio>

    <div id="flash"></div>
    <div class="vignette"></div>
    <div class="god-rays"></div>

    <div id="glass-backdrop"></div>

    <canvas id="lantern-canvas"></canvas>

    <div id="main-title">
        <h1 class="title-chinese">马大灯笼节</h1>
        <div class="title-english">PESTA TANGLUNG UM</div>
        <div class="title-sub">Grand Lucky Draw</div>
    </div>

    <div id="scramble-screen" class="content-layer">
        <div id="scramble-text">000</div>
    </div>

    <div id="winner-screen" class="content-layer">
        <div class="winner-label">✨ 天选之人 ✨</div>
        <div class="winner-number" id="result-text">---</div>
        <button style="margin-top: 5vh; font-size: 24px; padding: 12px 50px;" onclick="resetDraw()">下一位</button>
    </div>

    <canvas id="firework-canvas"></canvas>

    <div id="controls">
        <button id="ignite-btn" onclick="startDraw()">⚡ 启 动 ⚡</button>
    </div>

    <script>
        const Config = {
            totalParticipants: 450,
            drawDuration: 4000,
            lanternCount: 65,
            baseSpeed: 1.5,
            stormMaxSpeed: 30.0,
            fireworksCount: 80,
            confettiCount: 150
        };

        const State = {
            mode: 'IDLE',
            width: 0,
            height: 0,
            globalSpeedMultiplier: 1.0,
            lastTime: 0
        };

        // --- ASSETS ---
        const lanternCache = [];
        function preRenderLanterns() {
            const cacheCount = 12;
            for (let i = 0; i < cacheCount; i++) {
                const size = 42 + Math.random() * 26.25;
                const c = document.createElement('canvas');
                c.width = size * 3; c.height = size * 4;
                const ctx = c.getContext('2d');
                ctx.translate(size * 1.5, size * 1.5);
                const hue = Math.floor(Math.random() * 40);

                ctx.shadowBlur = 40; ctx.shadowColor = `hsla(${hue}, 100%, 60%, 0.8)`;
                const w = size * 0.55; const h = size * 0.75;
                const grd = ctx.createLinearGradient(-w / 2, -h / 2, w / 2, h / 2);
                grd.addColorStop(0, `hsla(${hue}, 100%, 70%, 1)`);
                grd.addColorStop(1, `hsla(${hue}, 100%, 50%, 1)`);
                ctx.beginPath(); ctx.moveTo(-w / 2, -h / 2); ctx.lineTo(w / 2, -h / 2);
                ctx.lineTo(w / 3, h / 2); ctx.lineTo(-w / 3, h / 2); ctx.closePath();
                ctx.fillStyle = grd; ctx.fill();

                ctx.shadowBlur = 0; ctx.strokeStyle = "rgba(255, 255, 220, 0.7)"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(-w / 2, -h / 2); ctx.lineTo(-w / 3, h / 2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(w / 2, -h / 2); ctx.lineTo(w / 3, h / 2); ctx.stroke();

                ctx.shadowBlur = 20; ctx.shadowColor = "#fff";
                ctx.beginPath(); ctx.arc(0, h / 4, w / 5, 0, Math.PI * 2); ctx.fillStyle = "#fff"; ctx.fill();

                lanternCache.push({ img: c, width: c.width, height: c.height });
            }
        }

        // --- CLASSES ---
        class Lantern {
            constructor() {
                this.reset();
                this.y = Math.random() * State.height;
                this.swingPhase = Math.random() * Math.PI * 2;
            }
            reset() {
                this.x = Math.random() * State.width;
                this.y = State.height + Math.random() * 200;
                this.baseSpeed = Math.random() * 0.5 + 0.5;
                this.sprite = lanternCache[Math.floor(Math.random() * lanternCache.length)];
                this.swingPhase = Math.random() * Math.PI * 2;
                this.swingSpeed = 0.02 + Math.random() * 0.02;
                this.scale = 1.0 + Math.random() * 0.7;
            }
            update(dt) {
                const speed = this.baseSpeed * State.globalSpeedMultiplier * dt;
                this.y -= speed;
                this.swingPhase += this.swingSpeed * dt;
                this.x += Math.sin(this.swingPhase * 0.5) * 0.2 * dt;
                if (this.y < -150) this.reset();
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.sin(this.swingPhase) * 0.1);
                ctx.scale(this.scale, this.scale);
                ctx.drawImage(this.sprite.img, -this.sprite.width / 2, -this.sprite.height / 2);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, isConfetti = false) {
                this.x = x; this.y = y;
                this.isConfetti = isConfetti;
                this.life = 1.0;
                const angle = Math.random() * Math.PI * 2;
                if (isConfetti) {
                    this.vx = (Math.random() - 0.5) * 5;
                    this.vy = (Math.random() - 0.5) * 5 - 5;
                    this.drag = 0.95; this.gravity = 0.15; this.decay = 0.005;
                    this.size = Math.random() * 5 + 3;
                    this.color = `hsl(${40 + Math.random() * 20}, 100%, 75%)`;
                    this.rotation = Math.random() * Math.PI;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.2;
                } else {
                    const speed = Math.random() * 15 + 5;
                    this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                    this.drag = 0.96; this.gravity = 0.03; this.decay = Math.random() * 0.015 + 0.005;
                    this.size = Math.random() * 4 + 2;
                    this.color = `hsl(${Math.random() * 50}, 100%, 85%)`;
                }
            }
            update(dt) {
                this.x += this.vx * dt; this.y += this.vy * dt;
                this.vx *= this.drag; this.vy *= this.drag; this.vy += this.gravity * dt;
                this.life -= this.decay * dt;
                if (this.isConfetti) this.rotation += this.rotationSpeed * dt;
            }
            draw(ctx) {
                const alpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;

                if (this.isConfetti) {
                    ctx.globalAlpha = alpha;
                    ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
                    ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                    ctx.restore();
                } else {
                    // Optimized Glow (Fake Shadow)
                    ctx.globalAlpha = alpha * 0.4;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 4, 0, Math.PI * 2); ctx.fill();

                    // Core
                    ctx.globalAlpha = alpha;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
                ctx.globalAlpha = 1.0;
            }
        }

        // --- RENDER LOOP ---
        const lCanvas = document.getElementById('lantern-canvas');
        const lCtx = lCanvas.getContext('2d');

        const fCanvas = document.getElementById('firework-canvas');
        const fCtx = fCanvas.getContext('2d');

        const lanterns = [];
        let particles = [];

        function init() {
            resize();
            preRenderLanterns();
            for (let i = 0; i < Config.lanternCount; i++) lanterns.push(new Lantern());
            requestAnimationFrame(loop);
        }

        function resize() {
            State.width = window.innerWidth;
            State.height = window.innerHeight;
            lCanvas.width = State.width; lCanvas.height = State.height;
            fCanvas.width = State.width; fCanvas.height = State.height;
        }
        window.addEventListener('resize', resize);

        function loop(timestamp) {
            if (!State.lastTime) State.lastTime = timestamp;
            const deltaTime = (timestamp - State.lastTime) / 16.67;
            State.lastTime = timestamp;
            const dt = Math.min(deltaTime, 3.0);

            const targetMultiplier = (State.mode === 'STORM') ? Config.stormMaxSpeed : 1.0;
            State.globalSpeedMultiplier += (targetMultiplier - State.globalSpeedMultiplier) * 0.05 * dt;

            lCtx.clearRect(0, 0, State.width, State.height);
            fCtx.clearRect(0, 0, State.width, State.height);

            lCtx.globalCompositeOperation = 'lighter';
            for (let i = 0; i < lanterns.length; i++) {
                lanterns[i].update(dt);
                lanterns[i].draw(lCtx);
            }

            fCtx.globalCompositeOperation = 'lighter';
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.update(dt);
                p.draw(fCtx);
                if (p.life <= 0) particles.splice(i, 1);
            }

            requestAnimationFrame(loop);
        }

        // --- GAME LOGIC ---
        let scrambleInterval;
        const sfxStorm = document.getElementById('sfx-storm');
        const sfxBoom = document.getElementById('sfx-boom');

        const els = {
            glass: document.getElementById('glass-backdrop'),
            scrambleScreen: document.getElementById('scramble-screen'),
            winnerScreen: document.getElementById('winner-screen'),
            scrambleText: document.getElementById('scramble-text'),
            resultText: document.getElementById('result-text'),
            igniteBtn: document.getElementById('ignite-btn'),
            title: document.getElementById('main-title'),
            flash: document.getElementById('flash')
        };

        function startDraw() {
            els.igniteBtn.style.opacity = '0';
            els.igniteBtn.style.pointerEvents = 'none';
            els.title.style.opacity = '0';
            els.title.style.transform = 'translate(-50%, -50%) scale(0.8)';

            try { sfxStorm.currentTime = 0; sfxStorm.play(); } catch (e) { }

            State.mode = 'STORM';

            // Show Glass + Scramble
            els.glass.classList.add('visible');
            els.scrambleScreen.classList.add('visible');
            els.scrambleScreen.classList.add('scrambling');

            clearInterval(scrambleInterval);
            scrambleInterval = setInterval(() => {
                const r = Math.floor(Math.random() * Config.totalParticipants) + 1;
                els.scrambleText.innerText = r;
            }, 50);

            setTimeout(revealWinner, Config.drawDuration);
        }

        function getSecureRandomNumber(max) {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return Math.floor((array[0] / 4294967296) * max) + 1;
        }

        function revealWinner() {
            clearInterval(scrambleInterval);
            const winningNumber = getSecureRandomNumber(Config.totalParticipants);

            // Switch screens
            els.scrambleScreen.classList.remove('visible');
            els.scrambleScreen.classList.remove('scrambling');

            try { sfxStorm.pause(); sfxBoom.currentTime = 0; sfxBoom.play(); } catch (e) { }

            els.flash.style.opacity = '0.8';
            setTimeout(() => { els.flash.style.opacity = '0'; }, 100);

            State.mode = 'IDLE';

            // Set Body Class for Z-Index change
            document.body.classList.add('winner-revealed');

            els.resultText.innerText = winningNumber;
            els.winnerScreen.classList.add('visible');

            els.resultText.classList.remove('number-pop');
            void els.resultText.offsetWidth;
            els.resultText.classList.add('number-pop');

            spawnExplosion(State.width / 2, State.height / 2, true);
            setTimeout(() => spawnExplosion(State.width / 2 - 300, State.height / 2, false), 200);
            setTimeout(() => spawnExplosion(State.width / 2 + 300, State.height / 2, false), 400);
        }

        function resetDraw() {
            document.body.classList.remove('winner-revealed');
            els.winnerScreen.classList.remove('visible');
            els.glass.classList.remove('visible'); // Hide glass

            els.igniteBtn.style.opacity = '1';
            els.igniteBtn.style.pointerEvents = 'auto';
            els.title.style.opacity = '1';
            els.title.style.transform = 'translate(-50%, -50%) scale(1)';

            State.mode = 'IDLE';
            particles = [];
        }

        function spawnExplosion(x, y, includeConfetti) {
            for (let i = 0; i < Config.fireworksCount; i++) {
                particles.push(new Particle(x, y, false));
            }
            if (includeConfetti) {
                for (let i = 0; i < Config.confettiCount; i++) {
                    particles.push(new Particle(x, y, true));
                }
            }
        }

        init();

    </script>
</body>

</html>